// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  player
  admin
  store
  seller
}

model Type {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  createDate DateTime @default(now())

  cardsIDs String[] @db.ObjectId
  cards    Card[]   @relation(fields: [cardsIDs], references: [id])
}

model Archetype {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  createDate DateTime @default(now())

  cardsIDs String[] @db.ObjectId
  cards    Card[]   @relation(fields: [cardsIDs], references: [id])

  decks Deck[]
}

model Keyword {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  createDate DateTime @default(now())

  cardsIDs String[] @db.ObjectId
  cards    Card[]   @relation(fields: [cardsIDs], references: [id])
}

model Rarity {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  createDate DateTime    @default(now())
  Card       CardPrice[]

  cardsIDs String[] @db.ObjectId
  cards    Card[]   @relation(fields: [cardsIDs], references: [id])
}

model Product {
  id           String         @id @default(auto()) @map("_id") @db.ObjectId
  index        Int
  name         String
  code         String         @unique
  releaseDate  String
  description  String
  url          String
  numberCards  Int
  show         Boolean
  createDate   DateTime       @default(now())
  Card         Card[]
  ProductImage ProductImage[]
}

model ProductImage {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  url        String
  alt        String
  createDate DateTime @default(now())

  product   Product @relation(fields: [productId], references: [id])
  productId String  @db.ObjectId
}

model Card {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  idd        String
  code       String
  limit      String
  cost       Int
  force      String
  defense    String
  name       String
  effect     String
  createDate DateTime @default(now())

  price CardPrice[]

  typeIds String[] @db.ObjectId
  types   Type[]   @relation(fields: [typeIds], references: [id])

  archetypesIds String[]    @db.ObjectId
  archetypes    Archetype[] @relation(fields: [archetypesIds], references: [id])

  keywordsIds String[]  @db.ObjectId
  keywords    Keyword[] @relation(fields: [keywordsIds], references: [id])

  raritiesIds String[] @db.ObjectId
  rarities    Rarity[] @relation(fields: [raritiesIds], references: [id])

  product   Product @relation(fields: [productId], references: [id])
  productId String  @db.ObjectId

  @@index([cost, force, defense])
}

model CardPrice {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  price      Float    @default(0)
  createDate DateTime @default(now())

  rarityId String @db.ObjectId
  rarity   Rarity @relation(fields: [rarityId], references: [id])

  cardId String @db.ObjectId
  card   Card   @relation(fields: [cardId], references: [id])
}

model Store {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  city       String
  address    String
  country    String
  postalCode String
  phone      String
  lat        Float
  lgn        Float
  url        String
  createDate DateTime @default(now())

  Tournament Tournament[]
}

model Tournament {
  id                 String           @id @default(auto()) @map("_id") @db.ObjectId
  title              String
  descripcion        String
  lat                Float
  lgn                Float
  format             TournamentFormat @default(Masters)
  date               DateTime         @default(now())
  image              String?
  status             TournamentStatus @default(pending)
  currentRoundNumber Int              @default(0)
  maxRounds          Int              @default(1)
  createDate         DateTime         @default(now())

  storeId String @db.ObjectId
  store   Store  @relation(fields: [storeId], references: [id])

  typeTournamentId String         @db.ObjectId
  typeTournament   TypeTournament @relation(fields: [typeTournamentId], references: [id])

  tournamentPlayers TournamentPlayer[]
  tournamentRounds  Round[]

  @@index([status])
  @@index([storeId])
}

model TypeTournament {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  createDate DateTime @default(now())

  Tournament Tournament[]
}

enum TournamentFormat {
  default
  Masters
}

enum TournamentStatus {
  pending
  in_progress
  finished
}

enum MatchResult {
  P1
  P2
  DRAW
}

model TournamentPlayer {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  tournamentId   String   @db.ObjectId
  userId         String   @db.ObjectId
  playerNickname String
  name           String?
  lastname       String?
  image          String?
  points         Int      @default(0)
  pointsInitial  Int      @default(0)
  hadBye         Boolean  @default(false)
  buchholz       Int      @default(0)
  rivals         String[] @default([]) @db.ObjectId
  createDate     DateTime @default(now())

  tournament Tournament @relation(fields: [tournamentId], references: [id])

  @@index([tournamentId])
  @@index([tournamentId, userId])
  @@index([points])
}

model Round {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  roundNumber  Int
  tournamentId String   @db.ObjectId
  matches      Match[]
  createDate   DateTime @default(now())

  tournament Tournament @relation(fields: [tournamentId], references: [id])

  @@index([tournamentId])
}

model Match {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  roundId         String       @db.ObjectId
  player1Id       String       @db.ObjectId
  player1Nickname String
  player2Id       String?      @db.ObjectId
  player2Nickname String?
  result          MatchResult?
  createdAt       DateTime     @default(now())

  round Round @relation(fields: [roundId], references: [id])

  @@index([roundId])
}

enum UserStatus {
  active
  inactive
  banned
}

model User {
  id                String       @id @default(auto()) @map("_id") @db.ObjectId
  name              String?
  lastname          String?
  email             String?      @unique
  nickname          String       @unique
  country           String?
  city              String?
  tournamentsPlayed Int          @default(0)
  password          String?
  emailVerified     DateTime?
  image             String       @default("player")
  role              Role         @default(player)
  status            UserStatus   @default(active)
  accounts          Account[]
  sessions          Session[]
  likes             Like[]
  decks             Deck[]
  userAvatar        UserAvatar[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.String
  access_token      String? @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.String
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String   @unique
  token      String
  expires    DateTime
}

model TypeLike {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  createDate DateTime @default(now())

  likes Like[]
}

model Like {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  idLike String

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  typeLikeId String   @db.ObjectId
  typeLike   TypeLike @relation(fields: [typeLikeId], references: [id])

  createdAt DateTime @default(now())
}

model Deck {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  imagen      String
  cards       String
  cardsNumber Int     @default(0)
  visible     Boolean

  likesCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tournamentId String? @db.ObjectId

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  archetypeId String    @db.ObjectId
  archetype   Archetype @relation(fields: [archetypeId], references: [id])
}

enum AvatarRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
  EVENT
}

model Avatar {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  imageUrl    String
  rarity      AvatarRarity @default(COMMON)
  isExclusive Boolean      @default(false)
  userAvatars UserAvatar[]

  createdAt DateTime @default(now())
}

model UserAvatar {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  unlocked Boolean @default(false)

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  avatarId String @db.ObjectId
  avatar   Avatar @relation(fields: [avatarId], references: [id])

  createdAt DateTime @default(now())
}
